--- 
layout: post
title: Weight Loss Predictor
categories: 
- r
- health
- montecarlo
- org-mode
- statistics
---







<p>
Got for 2010 Xmas a very cool book called the "4 Hour Body"(thanks Jose Santos) written by Tim Ferriss who write a previous favorite of mine about productivity, the 4 hour work week.
</p>
<p>
Its an interesting book, because it has a scientific approach, it doesn't just say do this do that and you'll be healthy, it actually says: I(Tim Ferriss) have tried this, exactly with these steps, during this time, this is how i measured, these are the results i got and by looking at most up-to-date medical research this is the most likely explanation for these results&hellip; Notice the similar principles of AB testing.
</p>
<p>
This book couldn't have arrived in a better time as i just peeked my heaviest weight in a  long time, blame it on [insert favorite reason]&hellip; so, long story short and I am now on the 3rd week of the low-carb diet described in the book. 
</p>
<p>
But of course, like with all diets, I'm quickly growing impatient of when i'm going to reach my goal (<a href="http://www.wolframalpha.com/input/?i=body+mass+index&amp;a=*C.body+mass+index-_*Formula.dflt-&amp;a=*FS-_**BodyMassIndex.BMI-.*BodyMassIndex.H-.*BodyMassIndex.W--&amp;f3=75+kg&amp;x=11&amp;y=4&amp;f=BodyMassIndex.W_75+kg&amp;f4=176+cm&amp;f=BodyMassIndex.H_176+cm&amp;a=*FVarOpt.1-_**-.***BodyMassIndex.S---.*--">of adequate BMI</a>), so lets use R and monte carlo simulations to generate predictions and understand better what to expect.
</p>

<div class="outline-2" id="outline-container-1">
<h2 id="sec-1">Data </h2>
<div class="outline-text-2" id="text-1">


<p>
Have been tracking my weight using google spreadsheets, so i can get the data into R like so:
</p>



<pre class="src src-R"><span style="color: #b22222;"># </span><span style="color: #b22222;">load the data
</span>mydata = read.csv(<span style="color: #8b2252;">"http://spreadsheets.google.com/pub?key=0AnypY27pPCJydEwzYWxYWG1CcEpPLVQySTRrWml4OEE&amp;hl=en_GB&amp;single=true&amp;gid=3&amp;output=csv"</span>, header = <span style="color: #228b22;">TRUE</span>, na.strings = <span style="color: #8b2252;">"#VALUE!"</span>) 

<span style="color: #b22222;"># </span><span style="color: #b22222;">re - Something in Javascript? move NA's
</span>mydata = na.omit(mydata)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Create a new column with the proper date format
</span>mydata$timestamp = as.Date(mydata$timestamp, format=<span style="color: #8b2252;">'%d/%m/%Y'</span>)

tail(mydata, 5)
</pre>



<pre class="example">
     timestamp   kg delta      day
159 2011-03-24 75.1  -0.4 Thursday
160 2011-03-25 74.9  -0.2   Friday
161 2011-03-26 74.7  -0.2 Saturday
162 2011-03-27 74.7   0.0   Sunday
163 2011-03-28 75.0   0.3   Monday
</pre>



</div>

<div class="outline-3" id="outline-container-1_1">
<h3 id="sec-1_1">Normality </h3>
<div class="outline-text-3" id="text-1_1">


<p>
Normality is not really a requirement for this simulation, monte carlo methods are independent of the distribution, but lets have a look of how the weight is distributed for the past 3 years.
</p>



<pre class="src src-R"><span style="color: #b22222;"># </span><span style="color: #b22222;">include ggplot2
</span><span style="color: #008b8b;">library</span>(ggplot2)

gghist = <span style="color: #7f007f;">function</span> (mydata, mycolname) {
  pl = ggplot(data = mydata)
  subvp = viewport(width=0.35, height=0.35, x=0.84, y=0.84)

  his = pl + 
        geom_histogram(aes_string(x=mycolname,y=<span style="color: #8b2252;">"..density.."</span>),alpha=0.2) + 
        geom_density(aes_string(x=mycolname)) + 
        opts(title = names(mydata[mycolname]))

  qqp = pl + 
        geom_point(aes_string(sample=mycolname), stat=<span style="color: #8b2252;">"qq"</span>) + labs(x=<span style="color: #228b22;">NULL</span>, y=<span style="color: #228b22;">NULL</span>) + 
        opts(title = <span style="color: #8b2252;">"QQ"</span>)

  print(his)
  print(qqp, vp = subvp)
}

gghist(mydata, <span style="color: #8b2252;">"kg"</span>)
</pre>




<p>
<img src="http://al3xandr3.github.com/img/w-loss-normal.png" alt="http://al3xandr3.github.com/img/w-loss-normal.png" />
</p>
<p>
Could probably extract 3 different normal distributions from the above plot. But overall is nor far off from the normal distribution.
Before diet, for the past 4 years, my weight has been mostly(in average) 80.5kg, going up a lot in the last 6 months or so.
</p>
</div>
</div>

</div>

<div class="outline-2" id="outline-container-2">
<h2 id="sec-2">Predicting the Future </h2>
<div class="outline-text-2" id="text-2">


<p>
Now using Monte Carlo methods lets simulate the future based on the weight changes that happened since start of diet.
</p>
<p>
Because its going to use weight changes by day we need to do some trickery to fill in the missing days and calculate the changes for every single day. 
The idea for filling in missing days is; if we have only day1=81 and day3=80, then we calculate that day2=80.5, because in 2 days we see a diference of 1, then per day is 0.5. 
</p>
<p>
We can confirm(prove) that this calculated assumption is a good one, by later comparing the simulation on data with all days filled in against the same data with some removed days in the middle, and confirm that results are the same.
</p>
<p> 
So lets get the weight(kg) change(delta), for every day:
</p>



<pre class="src src-R"><span style="color: #008b8b;">library</span>(zoo) <span style="color: #b22222;"># </span><span style="color: #b22222;">for missing values interpolation
</span>
fill.all.days = <span style="color: #7f007f;">function</span> (mydata, timecolname, valuecolname) {
  dtrange = range(mydata[,timecolname])

  <span style="color: #b22222;"># </span><span style="color: #b22222;">create a data frame with every single day
</span>  alldays = data.frame(tmp=seq(as.Date(dtrange[1]), as.Date(dtrange[2]), <span style="color: #8b2252;">"days"</span>))
  colnames(alldays) = c(timecolname) <span style="color: #b22222;"># </span><span style="color: #b22222;">rename tmp to proper timecolname
</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">add the existing values
</span>  alldays = merge(alldays, mydata, by=timecolname, all=<span style="color: #228b22;">TRUE</span>)

  <span style="color: #b22222;"># </span><span style="color: #b22222;">fill in the missing ones
</span>  alldays[,valuecolname] = na.approx(alldays[,valuecolname])
  <span style="color: #7f007f;">return</span>(alldays)
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">from start of diet
</span>dietdata = subset(mydata, timestamp &gt;= <span style="color: #8b2252;">"2011-01-17"</span>)
lastweight = tail(dietdata$kg, n=1)

<span style="color: #b22222;"># </span><span style="color: #b22222;">fill in missing days
</span>dietalldays = fill.all.days(dietdata, <span style="color: #8b2252;">"timestamp"</span>, <span style="color: #8b2252;">"kg"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">get difference day by day into data frame
</span>kgdelta = diff(dietalldays$kg)
dietalldays$delta = c(0, kgdelta)

<span style="color: #b22222;"># </span><span style="color: #b22222;">print only the 10 last values
</span>tail(dietalldays, 5)
</pre>



<pre class="example">
    timestamp   kg delta      day
67 2011-03-24 75.1  -0.4 Thursday
68 2011-03-25 74.9  -0.2   Friday
69 2011-03-26 74.7  -0.2 Saturday
70 2011-03-27 74.7   0.0   Sunday
71 2011-03-28 75.0   0.3   Monday
</pre>



</div>

<div class="outline-3" id="outline-container-2_1">
<h3 id="sec-2_1">So what is going to be my weight in a week? </h3>
<div class="outline-text-3" id="text-2_1">





<pre class="src src-R">predict.weight.in.days = <span style="color: #7f007f;">function</span>(days, inicialweight, deltavector) {
  weight = inicialweight
  <span style="color: #7f007f;">for</span> (i <span style="color: #7f007f;">in</span> 1:days) {
    weight = weight + sample(deltavector, 1, replace=<span style="color: #228b22;">TRUE</span>)
  }
  <span style="color: #7f007f;">return</span>(weight)
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">simulate it 10k times
</span>mcWeightWeek = replicate(10000, predict.weight.in.days(7, lastweight, kgdelta))

summary(mcWeightWeek)
</pre>



<pre class="example">
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  70.20   73.40   74.10   74.10   74.77   78.10
</pre>


<p>
Another good thing about monte carlo methods is that they give a distribution of the prediction, so its possible to get a feeling of how certain the average is; either very certain with a big central peak, or not that certain when the graph is flatter and all over the place:
</p>



<pre class="src src-R">gghist(data.frame(kg=mcWeightWeek), <span style="color: #8b2252;">"kg"</span>)
</pre>




<p>
<img src="http://al3xandr3.github.com/img/w-loss-week.png" alt="http://al3xandr3.github.com/img/w-loss-week.png" />
</p>
</div>

</div>

<div class="outline-3" id="outline-container-2_2">
<h3 id="sec-2_2">And when am i getting to 75kg? </h3>
<div class="outline-text-3" id="text-2_2">





<pre class="src src-R">days.to.weight = <span style="color: #7f007f;">function</span>(weight, inicialweight, deltavector) {
  target = inicialweight
  days = 0
  <span style="color: #7f007f;">while</span> (target &gt; weight) {
    target = target + sample(deltavector, 1, replace=<span style="color: #228b22;">TRUE</span>)
     days = days + 1
     <span style="color: #7f007f;">if</span> (days &gt;= 1095) <span style="color: #b22222;"># </span><span style="color: #b22222;">if value too crazy just interrupt the loop
</span>        <span style="color: #7f007f;">break</span>
  }
  <span style="color: #7f007f;">return</span>(days)
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">simulate it 10k times
</span>mcDays75 = replicate(10000, days.to.weight(75, lastweight, kgdelta))

summary(mcDays75)
</pre>



<pre class="example">
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0       0       0       0       0       0
</pre>


<p>
And the cumulative distribution:
</p>



<pre class="src src-R"><span style="color: #b22222;"># </span><span style="color: #b22222;">add dates to it, from today's date + #days
</span>days75 = sort(Sys.Date() + mcDays75)

<span style="color: #b22222;"># </span><span style="color: #b22222;">get the ecdf values into a dataframe
</span>days75.ecdf = summarize(data.frame(days=days75), days = unique(days), 
                        ecdf = ecdf(days)(unique(days)))

<span style="color: #b22222;"># </span><span style="color: #b22222;">date where its 85% sure i'll reach goal
</span>prob85 = head(days75.ecdf[days75.ecdf$ecdf&gt;0.85,],1)

<span style="color: #b22222;"># </span><span style="color: #b22222;">plot
</span>ggplot(days75.ecdf, aes(days, ecdf)) + geom_step() +
       ylab(<span style="color: #8b2252;">"probability"</span>) + 
       geom_point(aes(x = prob85$days, y = prob85$ecdf)) +
       geom_text(aes(x = prob85$days, y = prob85$ecdf, 
                    label = paste(<span style="color: #8b2252;">"85% sure to be 75kg on"</span>,
                            format(prob85$days, <span style="color: #8b2252;">"%a, %d %b %Y"</span>))), 
                     hjust=-0.04)
</pre>




<p>
<img src="http://al3xandr3.github.com/img/w-loss-75.png" alt="http://al3xandr3.github.com/img/w-loss-75.png" />
</p>
<p>
Also note that, weight loss is faster at the beginning of a diet, it tends to slow down over time, so to keep the predictions valid we need to continue record the weight and re-run the predictions frequently.
</p>
<p>
But as you see the slow carb diet seems to work, even without exercise. Tim's book is great, focusing on the smallest things possible for the bigger results(=efficiency).
</p>
</div>
</div>

</div>

<div class="outline-2" id="outline-container-3">
<h2 id="sec-3"><i>Results Update</i> </h2>
<div class="outline-text-2" id="text-3">


<p>
Got to 75.0kg on 25 March!!!! Thats 67 days (aprox. 9 weeks) for a 9kg loss, thus aprox. 1kg per week. Which is within the recommended(0.9kg per week) weight loss recommendations. Thus am now within normal <a href="http://www.wolframalpha.com/input/?i=bmi+75kg+1.76m">BMI values</a>.
</p>
<p>
Regarding the diet itself i have to mention that a key food were lentils, that replaced all pasta, potato and rice, and became the main food. Around the 77kg, where i plateau'd the weight for a while, i relaxed the strict low carb diet and adopted some ideas from the <a href="http://www.southbeachdiet.com/sbd/publicsite/index.aspx">South Beach Diet</a>, that allows to add other things in moderation and makes a distinction between good and bad carbs, also stopped the binging(over-eating) 1 day per week.
This diet was done without any gym or sports, it was all about the food, will soon start to add some sport into the equation and see.
</p>
<p>
The predictor was surprisingly good, even with little data on the beginning of diet. With time there'a tendency to slow down, that is expected, so maybe adding a weight giving more importance to the most recent measures could improve accuracy in weight loss prediction with monte carlo methods.
</p>

</div>

<div class="outline-3" id="outline-container-3_1">
<h3 id="sec-3_1">References </h3>
<div class="outline-text-3" id="text-3_1">


<ul>
<li>Hard drive occupation prediction with R: <a href="http://lpenz.github.com/articles/df0pred-1/index.html">part 1</a> and <a href="http://lpenz.github.com/articles/df0pred-2/index.html">part 2</a>, and thanks to Leandro Penz on the feedback.
</li>
<li>Big thanks for Tim's book and Ze's gift, on jumpstarting this experiment!
</li>
</ul>

</div>
</div>
</div>

